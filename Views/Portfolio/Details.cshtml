@model StockMonitor_2.Models.Portfolio
<html>
<head>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
</head>
<body>
    <div>
        <h2><span id='companyName'></span></h2>
        <h4>(@Html.DisplayFor(model => model.Yritys))</h4>
    </div>

    <div>
        <hr />
        <dl class="dl-horizontal">
            <div class="row">
                <div class="col-sm-3">
                    <dt style="font-size:x-large;">Kurssi nyt</dt>
                    <dd><span id='currentPrice' style="font-size:x-large;color:green"></span></dd>
                    <dt style="font-size:large;">Avaus</dt>
                    <dd><span id='openingPrice' style="font-size:large;color:black"></span></dd>
                    <dt style="font-size:large;">Ylin</dt>
                    <dd><span id='highPrice' style="font-size:large;color:black"></span></dd>
                    <dt style="font-size:large;">Alin</dt>
                    <dd><span id='lowPrice' style="font-size:large;color:black"></span></dd>
                    <dt style="font-size:large;">Edellinen päätös</dt>
                    <dd><span id='previousClose' style="font-size:large;color:black"></dd>
                </div>
                <div class="col-sm-3">
                    <dt style="font-size:medium;font-weight:bold">P/E</dt>
                    <dd><span id='pe' style="font-size:medium"></span></dd>
                    <dt style="font-size:medium;font-weight:bold">PEG</dt>
                    <dd><span id='peg' style="font-size:medium"></span></dd>
                    <dt style="font-size:medium;font-weight:bold">P/S</dt>
                    <dd><span id='ps' style="font-size:medium"></span></dd>
                    <dt style="font-size:medium;font-weight:bold">P/B</dt>
                    <dd><span id='pb' style="font-size:medium"></span></dd>
                    <dt style="font-size:medium;font-weight:bold">Osinko per osake</dt>
                    <dd><span id='dividend' style="font-size:medium"></span></dd>
                    <dt style="font-size:medium;font-weight:bold">EPS</dt>
                    <dd><span id='eps' style="font-size:medium"></span></dd>
                </div>
                <div class="col-sm-4">
                    <dt style="font-size:medium;font-weight:bold">Maa</dt>
                    <dd><span id='country' style="font-size:medium"></span></dd>
                    <dt style="font-size:medium;font-weight:bold">Valuutta</dt>
                    <dd><span id='currency' style="font-size:medium"></span></dd>
                    <dt style="font-size:medium;font-weight:bold">Pörssi</dt>
                    <dd><span id='exchange' style="font-size:medium"></span></dd>
                    <dt style="font-size:medium;font-weight:bold">Toimiala</dt>
                    <dd><span id='sector' style="font-size:medium"></span></dd>
                </div>
            </div>
        </dl>
        <hr />
    </div>

    <div class="col-sm-12">
        <ul class="nav nav-pills">
            <li class="active"><a data-toggle="tab" href="#5days">5 päivää</a></li>
            <li><a data-toggle="tab" href="#30days">Kuukausi</a></li>
            <li><a data-toggle="tab" href="#6months">6 kuukautta</a></li>
            <li><a data-toggle="tab" href="#1year">1 vuosi</a></li>
            @*<li><a data-toggle="tab" href="#2years">2 vuotta</a></li>
        <li><a data-toggle="tab" href="#5years">5 vuotta</a></li>
        <li><a data-toggle="tab" href="#10years">10 vuotta</a></li>*@
            <li><a data-toggle="tab" href="#all">Kaikki</a></li>
        </ul>
    </div>
    <div class="tab-content">
        <div id="5days" class="tab-pane fade in active">
            <br />
            <br />
            <h3>Viimeiset 5 päivää</h3>
            <div class="col-sm-8" >
                <canvas id="chart5days" style="height:5vw;width:20vw"></canvas>
            </div>
        </div>
        <div id="30days" class="tab-pane fade">
            <br />
            <br />
            <h3>Viimeiset 30 päivää</h3>
            <div class="col-sm-8">
                <canvas id="chart1month" style="height:5vw;width:20vw"></canvas>
            </div>
            @*<div class="col-sm-3">
                <p hidden>Random text</p>
            </div>*@
        </div>
        <div id="6months" class="tab-pane fade">
            <br />
            <br />
            <h3>Viimeiset 6 kuukautta</h3>
            <div class="col-sm-8">
                <canvas id="chart6month" style="height:5vw;width:20vw"></canvas>
            </div>
            @*<div class="col-sm-3">
                <p hidden>Random text</p>
            </div>*@
        </div>
        <div id="1year" class="tab-pane fade">
            <br />
            <br />
            <h3>Viimeisin vuosi</h3>
            <div class="col-sm-12">
                <canvas id="chart1year"></canvas>
            </div>
        </div>
        <div id="all" class="tab-pane fade">
            <br />
            <br />
            <h3>Kaikki</h3>
            <div class="col-sm-12">
                <canvas id="chartAll"></canvas>
            </div>
        </div>
    </div>

    <div class="col-sm-12">
        <br />
        <p>
            <a class="btn btn-info" @Html.ActionLink("Takaisin", "Index")
        </p>
    </div>


</body>
</html>

<script type="text/javascript">
    //Get stock data from API(finnhub.io)
    //Construct url
    var a = 'https://finnhub.io/api/v1/quote?symbol=';
    var b = '@Html.DisplayFor(model => model.Yritys)';
    var c = '&token=btdnsi748v6p1d4q5pcg';
    function urlFHQuote() {
        uQuote = a + b + c
        return uQuote
    }
    urlFHQuote();

    //Get data from url
    //const url1 = uQuote;
    async function getStockInfo() {

        // Storing response
        //const response = await fetch(url1);
        const response = await fetch(uQuote);

        // Storing data in JSON
        var data = await response.json();
        //console.log(data);

        //Javascript destructuring
        const { c, o, h, l, pc } = data;
        document.getElementById('currentPrice').textContent = c.toFixed(2);
        document.getElementById('openingPrice').textContent = o.toFixed(2);
        document.getElementById('highPrice').textContent = h.toFixed(2);
        document.getElementById('lowPrice').textContent = l.toFixed(2);
        document.getElementById('previousClose').textContent = pc.toFixed(2);
    }
    getStockInfo();


    //Get company overview data (alphavantage)
    //Construct url
    var aOverview = 'https://www.alphavantage.co/query?function=OVERVIEW&symbol=';
    var b = '@Html.DisplayFor(model => model.Yritys)';
    var cOverview = '&apikey=P3FY8FMGNJ4C88D6';
    function urlAVCompanyData() {
        uCompanyOverview = aOverview + b + cOverview
        return uCompanyOverview
    }
    urlAVCompanyData();

    //Get data from url
    async function getCompanyData() {

        // Storing response
        const response = await fetch(uCompanyOverview);

        // Storing data in JSON
        var data = await response.json();
        console.log(data);

        //Javascript destructuring
        const { Name, Exchange, Country, Currency, Sector, PERatio, PEGRatio, PriceToSalesRatioTTM, PriceToBookRatio, DividendPerShare, EPS } = data;
        document.getElementById('companyName').textContent = Name;
        document.getElementById('exchange').textContent = Exchange;
        document.getElementById('country').textContent = Country;
        document.getElementById('currency').textContent = Currency;
        document.getElementById('sector').textContent = Sector;
        document.getElementById('pe').textContent = PERatio;
        document.getElementById('peg').textContent = PEGRatio;
        document.getElementById('ps').textContent = PriceToSalesRatioTTM;
        document.getElementById('pb').textContent = PriceToBookRatio;
        document.getElementById('dividend').textContent = DividendPerShare;
        document.getElementById('eps').textContent = EPS;
    }
    getCompanyData();

    //<-- CHARTS -->
    //JSON data from alphavantage

        //Construct url (compact JSON)
        var aCompanyData = 'https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol=';
        var b = '@Html.DisplayFor(model => model.Yritys)';
        var cCompanyData = '&outputsize=full&apikey=P3FY8FMGNJ4C88D6';
        function urlAVDailyCompact() {
            uDaily = aCompanyData + b + cCompanyData
            return uDaily
        }
        urlAVDailyCompact();

        //Get compact data from url - compact data used for one week and one month
        async function getDailyDataUrl() {
            // Storing response
            const response = await fetch(uDaily);
            // Storing data in JSON
            var data = await response.json();
            //console.log(data);
        }
        getDailyDataUrl();

        var dateList = [];
        var pricesList = [];
        var lastRefreshed = "";
        async function getDailyData() {
            const response = await fetch(uDaily);

            // Storing data in JSON
            var data = await response.json();
            //console.log(data);

            //Javascript destructuring
            //Collect dates from JSON
            var jsonDataDates = data['Time Series (Daily)'];
            for (var date in jsonDataDates) {
                dateList.push(date);
            }
        //console.log(dateList);

        //Collect closing prices JSON
        var jsonDataPrices = data['Time Series (Daily)'];
        for (var price in jsonDataPrices) {
            pricesList.push(jsonDataPrices[price]['4. close'])
        }
        //console.log(pricesList);

        //Get latest date from JSON (last refreshed)
        var lastRefreshed = data['Meta Data']['3. Last Refreshed'];
        //console.log(lastRefreshed);

        //<-- CREATE CHART FOR 1 WEEK -->

        //Offset date by one week (7days)
        var d = new Date();
        d.setDate(d.getDate() - 7);
        //console.log(d);

        //Convert date format to yyyy-MM-dd
        var dateFormattedWk = new Date(d);
        dateFormattedWk = [
            d.getFullYear(),
            ('0' + (d.getMonth() + 1)).slice(-2),
            ('0' + d.getDate()).slice(-2)
        ].join('-');
        //console.log(dateFormattedWk);

        //Get only last 7 days of data
        var startDateWk = dateFormattedWk;
        var endDateWk = lastRefreshed;
        var oneWeek = dateList.filter(function (obj) {
            return obj >= startDateWk && obj <= endDateWk;
        });
        //console.log(oneWeek);

        //Get last items from prices corresponding to days
        var numberOfDaysWk = 0;
        numberOfDaysWk = oneWeek.length;
        //console.log(numberOfDaysWk);

        //Get appropriate number of prices and reverse order of prices for chart (xsWeek)
        pricesList2 = [];
        pricesList2 = pricesList.reverse();
        var xsWeek = pricesList2.slice(Math.max(pricesList.length - numberOfDaysWk, 0));
        //console.log(xsWeek);

        //Reverse dates to correspond with prices on chart (ysWeek)
        var ysWeek = [];
        ysWeek = oneWeek.reverse();

        //Draw chart 1 WEEK with prices (xsWeek) and dates (ysWeek)
        function createChartWeek() {
            var ctx = document.getElementById('chart5days').getContext('2d');
            var myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        //label: 'Closing price',
                        data: xsWeek,
                        fill: false,
                        borderColor: [
                            'rgba(0,0,225, 1)'
                        ],
                        borderWidth: 1,
                        order: 1,
                    }],
                    labels: ysWeek,
                },
                options: {
                    legend: {
                        display: false
                    },
                    scales: {
                        yAxes: [{
                            ticks: {
                                // Include a dollar sign with the ticks
                                callback: function (value) {
                                    return '$' + value;
                                }
                            }
                        }]
                    }
                }
            });
        }
        createChartWeek();

        //<-- CREATE CHART FOR 1 MONTH -->
        //Using uDailyCompact

        //Offset date by one month (30 days)
        var dMth = new Date();
        dMth.setDate(dMth.getDate() - 30);
        //Convert date format to yyyy-MM-dd
        var dateFormattedMth = new Date(dMth);
        dateFormattedMth = [
            dMth.getFullYear(),
            ('0' + (dMth.getMonth() + 1)).slice(-2),
            ('0' + dMth.getDate()).slice(-2)
        ].join('-');
        //console.log(dateFormattedMth);
        //Get only last 7 days of data
        var startDateMth = dateFormattedMth;
        var endDateMth = lastRefreshed;
        var oneMonth = dateList.filter(function (obj) {
            return obj >= startDateMth && obj <= endDateMth;
        });
        //console.log(oneMonth);
        //Get last items from prices corresponding to days
        var numberOfDaysMth = 0;
        numberOfDaysMth = oneMonth.length;
        //console.log(numberOfDaysMth);
        //Get appropriate nnumber of prices
        var xsMonth = pricesList.slice(Math.max(pricesList.length - numberOfDaysMth, 0));
        //console.log(xsMonth);

        //Reverse dates to correspond with prices on chart (ysWeek)
        var ysMonth = [];
        ysMonth = oneMonth.reverse();

        //Draw chart 1 MONTH with prices (xsMonth) and dates (ysMonth)
        function createChartMonth() {
            var ctx = document.getElementById('chart1month').getContext('2d');
            var myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        //label: 'Closing price',
                        data: xsMonth,
                        fill: false,

                        borderColor: [
                            'rgba(0,0,225, 1)'
                        ],
                        borderWidth: 1,
                        order: 1,
                    }],
                    labels: ysMonth,
                },
                options: {
                    legend: {
                        display: false
                    },
                    scales: {
                        yAxes: [{
                            ticks: {
                                // Include a dollar sign with the ticks
                                callback: function (value) {
                                    return '$' + value;
                                }
                            }
                        }]
                    }
                }
            });
        }
        createChartMonth();

        //<-- CREATE CHART FOR 6 MONTHS-->

        //Construct url (full JSON)
        var aFull = 'https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol=';
        var bFull = '@Html.DisplayFor(model => model.Yritys)';
        var cFull = '&outputsize=full&apikey=P3FY8FMGNJ4C88D6';
            function urlAVDailyFull() {
                uDailyFull = aFull + bFull + cFull
                return uDailyFull
            }
            urlAVDailyFull();

            //Get full data from url - compact data used for one week and one month
            async function getFullDailyDataUrl() {
                // Storing response
                const response6mth = await fetch(uDailyFull);
                // Storing data in JSON
                var data = await response6mth.json();
                //console.log(data);
            }
            getFullDailyDataUrl();
            //console.log(uDailyFull);

            var dateList6mth = [];
            var pricesList6mth = [];
            var lastRefreshed6mth = "";
            //async function getDailyData6mth() {
            //    const response6mth = await fetch(uDailyFull);
            //}

            // Storing data in JSON (compact)
            //var dataFull = await response6mth.json();
            //console.log(data);

            //Javascript destructuring
            //Collect dates from JSON
            var jsonDataDates6mth = data['Time Series (Daily)'];
            for (var date in jsonDataDates6mth) {
                dateList6mth.push(date);
            }
            console.log(dateList6mth);

            //Collect closing prices JSON
            var jsonDataPrices6mth = data['Time Series (Daily)'];
            for (var price in jsonDataPrices6mth) {
                pricesList6mth.push(jsonDataPrices6mth[price]['4. close'])
                //pricesList.reverse();
            }
            console.log(pricesList6mth);

            //Get latest date from JSON (last refreshed)
            lastRefreshed6mth = data['Meta Data']['3. Last Refreshed'];
            //console.log(lastRefreshed6mth);

            //<-- CREATE CHART FOR 6 MONTHS -->

            //Offset date by six months (180 days)
            var d6mth = new Date();
            d6mth.setDate(d6mth.getDate() - 180);
            //console.log(d);

            //Convert date format to yyyy-MM-dd
            var dateFormatted6mth = new Date(d6mth);
            dateFormatted6mth = [
                d6mth.getFullYear(),
                ('0' + (d6mth.getMonth() + 1)).slice(-2),
                ('0' + d6mth.getDate()).slice(-2)
            ].join('-');
            //console.log(dateFormatted6mth);

            //Get only last 180 days of data
            var startDate6mth = dateFormatted6mth;
            var endDate6mth = lastRefreshed;
            var sixMonths = dateList.filter(function (obj) {
                return obj >= startDate6mth && obj <= endDate6mth;
            });
            //console.log(sixMonths);

            //Get last items from prices corresponding to days
            var numberOfDays6mth = 0;
            numberOfDays6mth = sixMonths.length;
            //console.log(numberOfDays6mth);

            //Get appropriate number of prices and reverse order of prices for chart (xsWeek)
            let pricesList6mth2 = [];
            pricesList6mth2 = pricesList6mth.reverse();
            var xs6mth = pricesList6mth2.slice(Math.max(pricesList6mth.length - numberOfDays6mth, 0));
            console.log(xs6mth);
            //Reverse dates to correspond with prices on chart (ysWeek)
            var ys6mth = [];
            ys6mth = sixMonths.reverse();

            //Draw chart 6 MONTHS with prices (xs6mth) and dates (ys6mth)
            function createChart6Months() {
                var ctx = document.getElementById('chart6month').getContext('2d');
                var myChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: [{
                            //label: 'Closing price',
                            data: xs6mth,
                            fill: false,
                            borderColor: [
                                'rgba(0,0,225, 1)'
                            ],
                            borderWidth: 1,
                            order: 1,
                        }],
                        labels: ys6mth,
                    },
                    options: {
                        legend: {
                            display:false
                        },
                        scales: {
                            yAxes: [{
                                ticks: {
                                    // Include a dollar sign with the ticks
                                    callback: function (value) {
                                        return '$' + value;
                                    }
                                }
                            }]
                        }
                    }
                });
            }
            createChart6Months();
        }
        
        
    

    


    ////Create chart - ALL
    //var xsAll = [];
    //var ysAll = [];
    //xsAll = pricesList.reverse();
    //ysAll = dateList.reverse();
    ////console.log(ysAll);
    //function createChartAll() {
    //    var ctx = document.getElementById('chartAll').getContext('2d');
    //    var myChart = new Chart(ctx, {
    //        type: 'line',
    //        data: {
    //            datasets: [{
    //                //label: 'Closing price',
    //                data: xsAll,
    //                fill: false,

    //                borderColor: [
    //                    'rgba(0,0,225, 1)'
    //                ],
    //                borderWidth: 1,
    //                order: 1,
    //            }],
    //            labels: ysAll,
    //        },
    //        options: {
    //            scales: {
    //                yAxes: [{
    //                    ticks: {
    //                        // Include a dollar sign with the ticks
    //                        callback: function (value) {
    //                            return '$' + value;
    //                        }
    //                    }
    //                }]
    //            }
    //        }
    //    });
    //};
    //createChartAll();
    getDailyData();
</script>
